<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin User Controls - PeerAid</title>
  <link rel="stylesheet" href="/assets/css/admin.css" />
  <style>
    /* Basic styling for the users table */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    table th, table td {
      border: 1px solid #ddd;
      padding: 8px;
    }
    table th {
      background-color: #f2f2f2;
      text-align: left;
    }
    button {
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>PeerAid Admin</h2>
    <ul>
      <li><a href="admin-dashboard.html">Dashboard</a></li>
      <li><a class="active" href="admin-user-controls.html">User Management</a></li>
      <li><a href="admin-feedback.html">Feedback</a></li>
      <li><a href="admin-sessions.html">Session Management</a></li>
      <li><a href="../landingUI/welcome.html">Logout</a></li>
    </ul>
  </div>

  <div class="main-content">
    <h1>User Management & Controls</h1>
    <table id="usersTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Username</th>
          <th>Email</th>
          <th>Role</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <!-- User rows will be dynamically inserted here -->
      </tbody>
    </table>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", async function() {
      try {
        // Fetch all users from the admin API.
        const response = await fetch("http://localhost:3000/admin/users", {
          method: "GET",
          headers: {
            "Content-Type": "application/json"
            // Add an Authorization header if needed.
          }
        });
        const data = await response.json();
        if (response.ok) {
          const usersTableBody = document.querySelector("#usersTable tbody");
          usersTableBody.innerHTML = "";
          data.users.forEach(user => {
            const row = document.createElement("tr");
            row.innerHTML = `
              <td>${user.id}</td>
              <td>${user.username}</td>
              <td>${user.email}</td>
              <td>${user.role}</td>
              <td>${user.suspended ? "Suspended" : "Active"}</td>
              <td>
                <button class="change-role" data-id="${user.id}">Change Role</button>
                <button class="toggle-suspend" data-id="${user.id}">${user.suspended ? "Activate" : "Suspend"}</button>
              </td>
            `;
            usersTableBody.appendChild(row);
          });

          // Attach event listener for Change Role buttons.
          document.querySelectorAll(".change-role").forEach(button => {
            button.addEventListener("click", async function() {
              const userId = this.getAttribute("data-id");
              const newRole = prompt("Enter new role (e.g., student, tutor, admin):");
              if (newRole) {
                const updateResponse = await fetch(`http://localhost:3000/admin/users/${userId}/role`, {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json"
                    // Include Authorization header if needed.
                  },
                  body: JSON.stringify({ role: newRole })
                });
                const updateData = await updateResponse.json();
                if (updateResponse.ok) {
                  alert("User role updated successfully");
                  location.reload();
                } else {
                  alert(updateData.error || "Failed to update user role");
                }
              }
            });
          });

          // Attach event listener for Suspend/Activate buttons.
          document.querySelectorAll(".toggle-suspend").forEach(button => {
            button.addEventListener("click", async function() {
              const userId = this.getAttribute("data-id");
              if (confirm("Are you sure you want to change the user's suspended status?")) {
                const suspendResponse = await fetch(`http://localhost:3000/admin/users/${userId}/suspend`, {
                  method: "PUT",
                  headers: {
                    "Content-Type": "application/json"
                    // Include Authorization header if needed.
                  },
                  // Optionally, you could pass additional data in the body if needed.
                  body: JSON.stringify({})
                });
                const suspendData = await suspendResponse.json();
                if (suspendResponse.ok) {
                  alert("User status updated successfully");
                  location.reload();
                } else {
                  alert(suspendData.error || "Failed to update user status");
                }
              }
            });
          });
        } else {
          console.error("Failed to fetch users:", data.error);
        }
      } catch (error) {
        console.error("Error fetching users:", error);
      }
    });
  </script>
</body>
</html>
